# CheckStream Three-Phase Architecture - Visual Guide

Quick visual reference for understanding how CheckStream's three phases work together.

## High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚â”€â”€â”€>â”‚ Phase 1  â”‚â”€â”€â”€>â”‚   LLM    â”‚â”€â”€â”€>â”‚ Phase 2  â”‚â”€â”€â”€>â”‚   User   â”‚
â”‚  Query   â”‚    â”‚ Ingress  â”‚    â”‚Generate  â”‚    â”‚Midstream â”‚    â”‚Response  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                               â”‚
                      â”‚                               â”‚
                      v                               v
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Validate â”‚                    â”‚  Check   â”‚
                â”‚ & Modify â”‚                    â”‚ Chunks   â”‚
                â”‚ Context  â”‚                    â”‚Real-time â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                               â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      v
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ Phase 3  â”‚
                                â”‚  Egress  â”‚
                                â”‚ Audit &  â”‚
                                â”‚ Footer   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Phase 1: Ingress (Pre-Generation)

### Purpose: Set Up LLM for Success

```
User Prompt
     â”‚
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PHASE 1: INGRESS                      â”‚
â”‚                   Latency: 2-8ms                        â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Classifier Pipeline: "ingress-check"          â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  Stage 1: Quick Filters (Parallel)             â”‚   â”‚
â”‚  â”‚  â”œâ”€ PII Detection                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ Prompt Injection Detection                  â”‚   â”‚
â”‚  â”‚  â””â”€ Topic Classification                        â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  Stage 2: Risk Assessment (Conditional)        â”‚   â”‚
â”‚  â”‚  â””â”€ Detailed Risk Scoring                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  Decision Logic:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Score > 0.99? â†’ BLOCK REQUEST               â”‚    â”‚
â”‚  â”‚ Score > 0.70? â†’ MODIFY CONTEXT              â”‚    â”‚
â”‚  â”‚ Score < 0.70? â†’ PASS THROUGH                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     v
Modified/Original Prompt
     â”‚
     v
   To LLM
```

### Example Decision Tree

```
Prompt: "Should I invest in crypto?"
    â†“
Classify Topic
    â†“
Financial Advice (Score: 0.95)
    â†“
    â”œâ”€ Score < 0.70? NO
    â”œâ”€ Score < 0.99? YES â†’ MODIFY CONTEXT
    â””â”€ Score > 0.99? NO
    â†“
Action: Add compliance instructions to context
    â†“
Send to LLM with modified context:
"You must not give personalized advice.
Include risk warnings. Suggest FCA adviser."
```

## Phase 2: Midstream (During Streaming)

### Purpose: Real-Time Safety Net

```
LLM Streaming Tokens
     â”‚
     â”œâ”€ Chunk 1: "I understand you're..."
     â”œâ”€ Chunk 2: "considering crypto..."
     â”œâ”€ Chunk 3: "investments. I cannot..."
     â””â”€ ...
     â”‚
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PHASE 2: MIDSTREAM                      â”‚
â”‚                  Latency: 3-6ms per chunk                â”‚
â”‚                                                          â”‚
â”‚  For EACH chunk:                                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Classifier Pipeline: "midstream-check"        â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  Stage: Ultra-Fast Parallel                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ Advice vs Information (2ms)                â”‚   â”‚
â”‚  â”‚  â”œâ”€ Risk Disclosure Check (1ms)                â”‚   â”‚
â”‚  â”‚  â””â”€ Misleading Claims (3ms)                    â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  Aggregation: first_positive (early exit)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  Decision Logic:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Score > 0.80? â†’ REDACT CHUNK & STOP         â”‚    â”‚
â”‚  â”‚ Score < 0.80? â†’ PASS & CONTINUE             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     v
Chunk to User (or [REDACTED])
```

### Streaming Timeline

```
Time    LLM Output          Check     Result      User Sees
â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms     Generate chunk 1
10ms    "I understand"      3ms       Pass   â†’    "I understand"
                            âœ“

20ms    Generate chunk 2
30ms    "you're considering"3ms       Pass   â†’    "you're considering"
                            âœ“

40ms    Generate chunk 3
50ms    "crypto. However,"  3ms       Pass   â†’    "crypto. However,"
                            âœ“

60ms    Generate chunk 4
70ms    "I recommend 80%"   2ms       BLOCK! â†’    "[REDACTED]"
                            âœ—                     [Stream ends]
```

## Phase 3: Egress (Post-Generation)

### Purpose: Compliance & Evidence

```
Complete Response Generated
     â”‚
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PHASE 3: EGRESS                        â”‚
â”‚                   Latency: 10-50ms (async)               â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Classifier Pipeline: "egress-finalization"    â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  Stage: Comprehensive Review (Sequential)      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Complete Content Analysis (8ms)            â”‚   â”‚
â”‚  â”‚  â”œâ”€ Regulatory Compliance Check (7ms)          â”‚   â”‚
â”‚  â”‚  â””â”€ Audit Trail Generation (3ms)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  Actions:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1. Add Compliance Footer                     â”‚    â”‚
â”‚  â”‚ 2. Generate Audit Record                     â”‚    â”‚
â”‚  â”‚ 3. Store Cryptographic Evidence              â”‚    â”‚
â”‚  â”‚ 4. Update Metrics                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     v
Response + Footer to User
     â”‚
     v
Audit Record to Immutable Storage
```

### Footer Addition

```
Original Response:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
I understand you're considering crypto investments.
I cannot give personalized advice. Speak to an
FCA-regulated adviser.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                â†“ Phase 3 adds â†“

Final Response:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
I understand you're considering crypto investments.
I cannot give personalized advice. Speak to an
FCA-regulated adviser.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â„¹ï¸ This is general information, not financial advice.
ðŸ“ž Find an FCA adviser: www.unbiased.co.uk
âš ï¸ Investments can fall. You may lose money.
ðŸ”’ Logged for compliance (ID: CS-123ABC)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Complete Example Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  t=0ms: User asks: "Should I invest Â£50k in crypto?"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 v
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚        PHASE 1: INGRESS               â”‚
         â”‚                                       â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚  â”‚ Detect: Investment advice    â”‚   â”‚
         â”‚  â”‚ Risk: HIGH (0.95)            â”‚   â”‚
         â”‚  â”‚ Action: MODIFY CONTEXT       â”‚   â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â”‚                                       â”‚
         â”‚  Modified prompt:                    â”‚
         â”‚  "SYSTEM: You must not give advice.  â”‚
         â”‚   Include risk warnings. Refer to    â”‚
         â”‚   FCA adviser."                      â”‚
         â”‚                                       â”‚
         â”‚  Latency: 6ms                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         v
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          Send to LLM                  â”‚
         â”‚                                       â”‚
         â”‚  LLM generates with compliance        â”‚
         â”‚  instructions in context              â”‚
         â”‚                                       â”‚
         â”‚  Latency: 150ms (normal LLM time)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         v
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     PHASE 2: MIDSTREAM                â”‚
         â”‚                                       â”‚
         â”‚  Chunk 1: "I understand you're..."   â”‚
         â”‚  â”œâ”€ Check (3ms) â†’ âœ“ PASS             â”‚
         â”‚  â””â”€ Send to user                     â”‚
         â”‚                                       â”‚
         â”‚  Chunk 2: "considering crypto..."    â”‚
         â”‚  â”œâ”€ Check (3ms) â†’ âœ“ PASS             â”‚
         â”‚  â””â”€ Send to user                     â”‚
         â”‚                                       â”‚
         â”‚  ... (8 chunks total)                â”‚
         â”‚                                       â”‚
         â”‚  Chunk 8: "FCA-regulated adviser."   â”‚
         â”‚  â”œâ”€ Check (3ms) â†’ âœ“ PASS             â”‚
         â”‚  â””â”€ Send to user                     â”‚
         â”‚                                       â”‚
         â”‚  Total per-chunk latency: 24ms       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         v
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚       PHASE 3: EGRESS                 â”‚
         â”‚                                       â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚  â”‚ Analyze complete response    â”‚   â”‚
         â”‚  â”‚ Compliance: PASS (0.92)      â”‚   â”‚
         â”‚  â”‚ Add footer with:             â”‚   â”‚
         â”‚  â”‚  â€¢ Disclaimers               â”‚   â”‚
         â”‚  â”‚  â€¢ Risk warnings             â”‚   â”‚
         â”‚  â”‚  â€¢ FCA adviser link          â”‚   â”‚
         â”‚  â”‚  â€¢ Interaction ID            â”‚   â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â”‚                                       â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚  â”‚ Create audit record:         â”‚   â”‚
         â”‚  â”‚  â€¢ Timestamp                 â”‚   â”‚
         â”‚  â”‚  â€¢ Risk scores               â”‚   â”‚
         â”‚  â”‚  â€¢ Actions taken             â”‚   â”‚
         â”‚  â”‚  â€¢ Crypto signatures         â”‚   â”‚
         â”‚  â”‚  â€¢ Store immutably           â”‚   â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â”‚                                       â”‚
         â”‚  Latency: 18ms (async)               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  t=180ms: User receives compliant response + footer            â”‚
â”‚                                                                 â”‚
â”‚  "I understand you're considering crypto investments. I        â”‚
â”‚   cannot give personalized advice. Speak to an FCA-regulated   â”‚
â”‚   adviser..."                                                   â”‚
â”‚                                                                 â”‚
â”‚  â„¹ï¸ This is information only, not advice.                      â”‚
â”‚  ðŸ“ž Find FCA adviser: www.unbiased.co.uk                       â”‚
â”‚  âš ï¸ You may lose money. ID: CS-123ABC                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Latency Breakdown

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Total Time: 180ms                     â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚ Phase 1 â”‚ 6ms    Ingress validation               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            LLM Generation                   â”‚    â”‚
â”‚  â”‚               150ms                         â”‚    â”‚
â”‚  â”‚  (not CheckStream overhead)                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚  Phase 2    â”‚ 24ms   Per-chunk checks (8 chunks) â”‚
â”‚  â”‚  (parallel) â”‚        3ms Ã— 8 = 24ms               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚ Phase 3 â”‚ 18ms   Async (not in critical path)    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                       â”‚
â”‚  CheckStream Total Overhead: ~30ms in critical path  â”‚
â”‚  (Phase 1: 6ms + Phase 2: 24ms)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Phase Comparison Table

| Phase | When | Latency | Purpose | Action | Async? |
|-------|------|---------|---------|--------|--------|
| **1. Ingress** | Before LLM | 2-8ms | Proactive | Modify context | No |
| **2. Midstream** | During stream | 3-6ms/chunk | Reactive | Block chunks | No |
| **3. Egress** | After complete | 10-50ms | Evidential | Add footer | Yes |

## Pipeline Selection per Phase

```
Phase 1 (Ingress):
  â”œâ”€ Use: Comprehensive pre-check pipeline
  â”œâ”€ Classifiers: Tier A + B (fast but thorough)
  â””â”€ Example: "fca-ingress-check"

Phase 2 (Midstream):
  â”œâ”€ Use: Ultra-fast streaming pipeline
  â”œâ”€ Classifiers: Tier A + B only (< 5ms)
  â””â”€ Example: "fca-midstream-check"

Phase 3 (Egress):
  â”œâ”€ Use: Comprehensive analysis pipeline
  â”œâ”€ Classifiers: All tiers (A + B + C)
  â””â”€ Example: "fca-egress-finalization"
```

## Key Principles

### Phase 1: Prevention
```
Goal: Stop problems before they start
Method: Modify LLM context
Analogy: Giving instructions to a human
```

### Phase 2: Protection
```
Goal: Catch mistakes in real-time
Method: Filter output stream
Analogy: Cutting a live TV broadcast
```

### Phase 3: Proof
```
Goal: Create compliance evidence
Method: Audit + document
Analogy: Recording for the regulator
```

---

## See Also

- [FCA Example (Detailed)](FCA_EXAMPLE.md)
- [Pipeline Configuration](pipeline-configuration.md)
- [Integration Guide](INTEGRATION_GUIDE.md)
